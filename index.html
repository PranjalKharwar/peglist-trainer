<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peglist Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        /* Custom transition for a smoother feel */
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom focus ring */
        .form-input:focus, .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Notification style */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(200%);
            transition: transform 0.5s ease-in-out;
            z-index: 1000;
        }
        #notification.show {
            transform: translateX(-50%) translateY(0);
        }
        .feedback-correct {
            border: 2px solid #34d399 !important;
            background-color: #10b981 !important;
        }
        .feedback-incorrect {
            border: 2px solid #f87171 !important;
            background-color: #ef4444 !important;
        }
        /* Image Modal */
        #image-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #image-modal-backdrop.show {
            display: flex;
            opacity: 1;
        }
        #image-modal {
            margin: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }
        #image-modal-backdrop.show #image-modal {
            transform: scale(1);
        }
        /* Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active text-center p-6 bg-gray-800 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">Peglist Trainer</h1>
            <p class="text-gray-400 mb-8">Master the Major System and unlock your memory potential.</p>
            <div class="space-y-4">
                <button onclick="showScreen('quiz-setup-screen')" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Start Training</button>
                <button onclick="showScreen('settings-screen')" class="btn w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Edit My Peg List</button>
                <button onclick="showScreen('palace-list-screen')" class="btn w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">My Memory Palaces</button>
                <button onclick="showScreen('sync-screen')" class="btn w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Sync Data</button>
            </div>
        </div>
        
        <!-- Sync Screen -->
        <div id="sync-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">Sync Data</h2>
                <button onclick="showScreen('welcome-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">Export Data</h3>
                    <p class="text-sm text-gray-400 mb-4">Click to copy all your data (pegs, images, palaces) to your clipboard. Paste this on your other device.</p>
                    <button onclick="exportData()" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Export to Clipboard</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">Import Data</h3>
                    <p class="text-sm text-gray-400 mb-4">Paste your exported data below and click import. <strong class="text-red-400">Warning: This will overwrite all current data on this device.</strong></p>
                    <textarea id="import-data-area" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-2 h-24" placeholder="Paste your data here..."></textarea>
                    <button onclick="importData()" class="btn w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Import Data</button>
                </div>
            </div>
        </div>

        <!-- Settings Screen (Peg List) -->
        <div id="settings-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">My Peg List</h2>
                <button onclick="showScreen('welcome-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
            </div>
            <p class="text-gray-400 mb-4 text-sm">Enter your personal peg words here. Click the ✨ button to generate and save an image.</p>
            <div id="peg-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Peg list inputs will be generated by JS -->
            </div>
        </div>

        <!-- Memory Palace List Screen -->
        <div id="palace-list-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">Memory Palaces</h2>
                <button onclick="showScreen('welcome-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
            </div>
            <div id="palaces-container" class="space-y-3 mb-4"></div>
            <div class="flex space-x-2">
                <input type="text" id="new-palace-name" class="form-input flex-grow bg-gray-700 border-gray-600 rounded-lg p-2" placeholder="New palace name...">
                <button onclick="addPalace()" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
            </div>
        </div>

        <!-- Edit Memory Palace Screen -->
        <div id="edit-palace-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 id="edit-palace-title" class="text-2xl font-bold text-blue-400">Edit Palace</h2>
                <button onclick="showScreen('palace-list-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
            </div>
            <p class="text-gray-400 mb-4 text-sm">Add up to 100 locations (loci) to your palace. These will link to pegs 0-99.</p>
            <div id="loci-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Loci inputs will be generated by JS -->
            </div>
        </div>


        <!-- Quiz Setup Screen -->
        <div id="quiz-setup-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">Quiz Setup</h2>
                 <button onclick="showScreen('welcome-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
            </div>
            <div class="space-y-6">
                <div id="quiz-range-container">
                    <label class="block text-gray-400 mb-2 font-medium">Quiz Range</label>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="range-start" value="0" min="0" max="99" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-center">
                        <span class="text-gray-400">to</span>
                        <input type="number" id="range-end" value="99" min="0" max="99" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-center">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400 mb-2 font-medium">Quiz Mode</label>
                    <select id="quiz-mode" onchange="togglePalaceSelector()" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-3">
                        <option value="num-to-word">Number to Word (Type)</option>
                        <option value="word-to-num">Word to Number (Type)</option>
                        <option value="multiple-choice">Multiple Choice</option>
                        <option value="palace-walk">Palace Walk</option>
                    </select>
                </div>
                <div id="palace-selector-container" class="hidden">
                    <label class="block text-gray-400 mb-2 font-medium">Select Palace</label>
                    <select id="palace-selector" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-3"></select>
                </div>
                <button onclick="startQuiz()" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Begin Quiz</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <div id="progress-indicator" class="text-gray-400 font-medium"></div>
                <button onclick="showScreen('quiz-setup-screen')" class="btn bg-gray-700 hover:bg-gray-600 text-sm py-1 px-3 rounded-lg">End Quiz</button>
            </div>
            <div class="text-center bg-gray-900 p-8 rounded-lg mb-6">
                <p id="question-prompt" class="text-gray-400 text-lg mb-2"></p>
                <p id="question-display" class="text-4xl font-bold"></p>
                <div id="quiz-image-container" class="mt-4 flex justify-center items-center h-24">
                    <img id="quiz-image" src="" class="hidden max-h-full rounded-lg">
                </div>
            </div>
            
            <!-- Typing Answer Area -->
            <div id="typing-answer-area">
                <div class="relative">
                    <input type="text" id="answer-input" class="form-input w-full bg-gray-700 border-gray-600 rounded-lg p-4 text-center text-xl" placeholder="Type your answer...">
                    <div id="feedback-indicator" class="absolute right-3 top-1/2 -translate-y-1/2 text-2xl"></div>
                </div>
                 <button onclick="checkAnswer()" class="btn w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Submit</button>
            </div>

            <!-- Multiple Choice Area -->
            <div id="mc-answer-area" class="grid grid-cols-2 gap-4 mt-4">
                <!-- Buttons will be generated by JS -->
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen p-6 bg-gray-800 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-blue-400 mb-4 text-center">Quiz Complete!</h2>
            <div class="text-center bg-gray-900 p-6 rounded-lg mb-6">
                <p class="text-gray-400">Your Score</p>
                <p id="score-display" class="text-5xl font-bold"></p>
            </div>
            <div id="review-section">
                <h3 class="font-bold text-lg mb-2 text-gray-300">Review Incorrect Answers:</h3>
                <div id="incorrect-answers-list" class="space-y-2 text-sm"></div>
            </div>
            <div class="mt-8 space-y-3">
                <button onclick="startQuiz()" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Try Again</button>
                <button onclick="showScreen('quiz-setup-screen')" class="btn w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">New Quiz</button>
            </div>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg shadow-xl">
        <p id="notification-message"></p>
    </div>

    <!-- Image Modal -->
    <div id="image-modal-backdrop" class="items-center justify-center" onclick="closeImageModal()">
        <div id="image-modal" class="bg-gray-800 rounded-2xl shadow-lg p-4 w-11/12 max-w-sm" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="image-modal-title" class="text-xl font-bold text-blue-400">Image for...</h3>
                <button onclick="closeImageModal()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="image-modal-content" class="flex items-center justify-center bg-gray-900 rounded-lg min-h-[256px]">
                <div id="image-loader" class="loader"></div>
                <img id="generated-image" src="" alt="Generated Peg Image" class="hidden max-w-full max-h-full rounded-lg">
                <p id="image-error" class="hidden text-red-400">Could not generate image.</p>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let currentScreen = 'welcome-screen';
        let pegList = [];
        let memoryPalaces = [];
        let currentEditingPalaceId = null;
        let quizSettings = {};
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let notificationTimeout;

        // --- CORE FUNCTIONS ---

        function showNotification(message, isSuccess = false) {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            notification.classList.toggle('bg-red-500', !isSuccess);
            notification.classList.toggle('bg-green-500', isSuccess);
            notification.classList.add('show');
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
        }

        // --- PEG LIST LOGIC ---

        function initializePegList() {
            const savedList = localStorage.getItem('pegList');
            if (savedList) {
                pegList = JSON.parse(savedList);
            } else {
                const defaultWords = [
                    "SuS", "SiD", "SiNchan", "SiMba", "StaR", "SeaL", "SkyJack", "Saktimaan", "SoFa", "SuPerman",
                    "ToeS", "TaTTo", "TiN", "ToM", "TR ee", "TaiL", "TaJ mahal", "TeaK", "ToFFee", "TuBe",
                    "NeSt", "NeT", "NuN", "NeMo", "NuRse", "NaiL", "injection", "NiKe", "Navy", "NaPkeen",
                    "MouSe", "MaT", "MooN", "MaxiMus", "MiRror", "MeLon", "MoJito", "MilK", "MuFFin", "MaP",
                    "RoSe", "RaT", "RaiN", "RaMbo", "RoaR", "RaiL", "RaJa", "Rocket", "RaFt", "RoPe",
                    "LaSsi", "LaMp", "LaNtern", "LeMon", "LizaRd", "LiLy", "Lizard", "LoCK", "LooFa", "LaPtop",
                    "JaSmin", "JeT", "JunGle Book", "JaMbo", "JeRry", "JaiLor", "JoJo", "JocKer", "JoFra", "JeeP",
                    "CaSe", "CaT", "CaNe", "CaMel", "CaR", "CoKe", "CaSh", "CaKe", "CoFFee", "CaP",
                    "FoX", "FruiT", "FaN", "FoaM", "FiRe", "FiLe", "FiFa", "ForK", "FiFa", "FloPpy",
                    "BuS", "BaT", "BoNe", "BoMb", "BeeR", "BeLL", "BeaCh", "BiKe", "BuFFalo", "BuBble"
                ];
                pegList = defaultWords.map((word, i) => ({ number: i, word: word, imageUrl: null }));
                localStorage.setItem('pegList', JSON.stringify(pegList));
            }
            renderPegListSettings();
        }

        function renderPegListSettings() {
            const container = document.getElementById('peg-list-container');
            container.innerHTML = '';
            pegList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-2 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <label class="font-mono text-gray-400 text-lg">#${String(item.number).padStart(2, '0')}</label>
                        <button onclick="generateImageForPeg(${item.number})" class="btn bg-blue-600 hover:bg-blue-700 p-2 rounded-lg text-sm" title="Generate Image">✨ Gen</button>
                    </div>
                    <div class="flex items-center space-x-2 mt-2">
                        <div class="w-16 h-12 bg-gray-800 rounded-md flex-shrink-0 flex items-center justify-center">
                            <img src="${item.imageUrl || ''}" class="${item.imageUrl ? '' : 'hidden'} w-full h-full object-cover rounded-md cursor-pointer" onclick="showImageInModal('${item.word}', '${item.imageUrl}')">
                        </div>
                        <input type="text" value="${item.word}" onchange="savePegWord(${item.number}, this.value)" 
                               class="form-input w-full bg-gray-800 border-gray-700 rounded-lg p-2">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function savePegWord(number, word) {
            const item = pegList.find(p => p.number === number);
            if (item) {
                item.word = word.trim();
                localStorage.setItem('pegList', JSON.stringify(pegList));
            }
        }
        
        // --- MEMORY PALACE LOGIC ---
        
        function initializePalaces() {
            const savedPalaces = localStorage.getItem('memoryPalaces');
            memoryPalaces = savedPalaces ? JSON.parse(savedPalaces) : [];
            renderPalaceList();
            populatePalaceSelector();
        }

        function renderPalaceList() {
            const container = document.getElementById('palaces-container');
            container.innerHTML = '';
            memoryPalaces.forEach(palace => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                div.innerHTML = `
                    <span class="font-medium">${palace.name}</span>
                    <div>
                        <button onclick="editPalace('${palace.id}')" class="btn bg-blue-600 hover:bg-blue-700 text-sm py-1 px-3 rounded-lg">Edit</button>
                        <button onclick="deletePalace('${palace.id}')" class="btn bg-red-600 hover:bg-red-700 text-sm py-1 px-3 rounded-lg ml-2">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPalace() {
            const nameInput = document.getElementById('new-palace-name');
            const name = nameInput.value.trim();
            if (name) {
                const newPalace = {
                    id: `palace_${Date.now()}`,
                    name: name,
                    loci: Array.from({ length: 100 }, () => '')
                };
                memoryPalaces.push(newPalace);
                savePalaces();
                nameInput.value = '';
            }
        }

        function deletePalace(palaceId) {
            memoryPalaces = memoryPalaces.filter(p => p.id !== palaceId);
            savePalaces();
        }

        function editPalace(palaceId) {
            currentEditingPalaceId = palaceId;
            const palace = memoryPalaces.find(p => p.id === palaceId);
            if (palace) {
                document.getElementById('edit-palace-title').textContent = `Editing: ${palace.name}`;
                renderLociList(palace);
                showScreen('edit-palace-screen');
            }
        }

        function renderLociList(palace) {
            const container = document.getElementById('loci-list-container');
            container.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `
                    <label class="w-12 text-right font-mono text-gray-400">#${String(i).padStart(2, '0')}</label>
                    <input type="text" value="${palace.loci[i] || ''}" onchange="saveLocus(${i}, this.value)" 
                           class="form-input flex-grow bg-gray-700 border-gray-600 rounded-lg p-2" placeholder="Location ${i}...">
                `;
                container.appendChild(div);
            }
        }
        
        function saveLocus(index, value) {
            const palace = memoryPalaces.find(p => p.id === currentEditingPalaceId);
            if (palace) {
                palace.loci[index] = value.trim();
                savePalaces(false);
            }
        }

        function savePalaces(shouldRender = true) {
            localStorage.setItem('memoryPalaces', JSON.stringify(memoryPalaces));
            if (shouldRender) {
                renderPalaceList();
            }
            populatePalaceSelector();
        }

        function populatePalaceSelector() {
            const selector = document.getElementById('palace-selector');
            selector.innerHTML = '';
            memoryPalaces.forEach(palace => {
                const option = document.createElement('option');
                option.value = palace.id;
                option.textContent = palace.name;
                selector.appendChild(option);
            });
        }

        function togglePalaceSelector() {
            const mode = document.getElementById('quiz-mode').value;
            const palaceContainer = document.getElementById('palace-selector-container');
            const rangeContainer = document.getElementById('quiz-range-container');
            if (mode === 'palace-walk') {
                palaceContainer.classList.remove('hidden');
                rangeContainer.classList.add('hidden');
            } else {
                palaceContainer.classList.add('hidden');
                rangeContainer.classList.remove('hidden');
            }
        }


        // --- IMAGE GENERATION ---

        function showImageInModal(pegWord, imageUrl) {
            if (!imageUrl) return;
            const modalBackdrop = document.getElementById('image-modal-backdrop');
            const modalTitle = document.getElementById('image-modal-title');
            const loader = document.getElementById('image-loader');
            const imgEl = document.getElementById('generated-image');
            const errorEl = document.getElementById('image-error');

            modalTitle.textContent = `Image for "${pegWord}"`;
            loader.style.display = 'none';
            imgEl.src = imageUrl;
            imgEl.style.display = 'block';
            errorEl.style.display = 'none';
            modalBackdrop.classList.add('show');
        }

        async function generateImageForPeg(pegNumber) {
            const pegItem = pegList.find(p => p.number === pegNumber);
            if (!pegItem) return;

            const modalBackdrop = document.getElementById('image-modal-backdrop');
            const modalTitle = document.getElementById('image-modal-title');
            const loader = document.getElementById('image-loader');
            const imgEl = document.getElementById('generated-image');
            const errorEl = document.getElementById('image-error');

            modalTitle.textContent = `Generating for "${pegItem.word}"...`;
            loader.style.display = 'block';
            imgEl.style.display = 'none';
            errorEl.style.display = 'none';
            modalBackdrop.classList.add('show');

            // NEW: Simplified and direct prompt for clearer images
            const userPrompt = `A simple, clear, cartoon-style icon of '${pegItem.word}', on a plain white background. Clean vector art.`;
            
            try {
                const payload = { instances: [{ prompt: userPrompt }], parameters: { "sampleCount": 1 } };
                const apiKey = "AIzaSyCwHiMKso7du_W5KFb_BuTW0nPQej3PVFU";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.predictions && result.predictions[0] && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    imgEl.src = imageUrl;
                    imgEl.style.display = 'block';
                    
                    pegItem.imageUrl = imageUrl;
                    localStorage.setItem('pegList', JSON.stringify(pegList));
                    renderPegListSettings();
                } else {
                    throw new Error('Invalid response structure from API.');
                }
            } catch (err) {
                console.error('Image generation failed:', err);
                errorEl.style.display = 'block';
            } finally {
                loader.style.display = 'none';
                modalTitle.textContent = `Image for "${pegItem.word}"`;
            }
        }

        function closeImageModal() {
            document.getElementById('image-modal-backdrop').classList.remove('show');
        }

        // --- SYNC LOGIC ---
        function exportData() {
            const dataToExport = {
                pegList: pegList,
                memoryPalaces: memoryPalaces
            };
            const dataString = JSON.stringify(dataToExport);
            
            const textArea = document.createElement("textarea");
            textArea.value = dataString;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('Data copied to clipboard!', true);
            } catch (err) {
                showNotification('Failed to copy data.');
            }
            document.body.removeChild(textArea);
        }

        function importData() {
            const dataString = document.getElementById('import-data-area').value;
            if (!dataString) {
                showNotification('Paste data into the text area first.');
                return;
            }
            try {
                const importedData = JSON.parse(dataString);
                if (importedData.pegList && importedData.memoryPalaces) {
                    localStorage.setItem('pegList', JSON.stringify(importedData.pegList));
                    localStorage.setItem('memoryPalaces', JSON.stringify(importedData.memoryPalaces));
                    showNotification('Data imported successfully! App will now reload.', true);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showNotification('Invalid data format.');
                }
            } catch (err) {
                showNotification('Error parsing data. Make sure it is correct.');
            }
        }


        // --- QUIZ LOGIC ---

        function startQuiz() {
            const quizMode = document.getElementById('quiz-mode').value;
            quizSettings = { quizMode };
            
            if (quizMode === 'palace-walk') {
                const palaceId = document.getElementById('palace-selector').value;
                const palace = memoryPalaces.find(p => p.id === palaceId);
                if (!palace) {
                    showNotification("Please select a valid palace.");
                    return;
                }
                quizSettings.palace = palace;
                quizQuestions = palace.loci
                    .map((locus, index) => ({ locus, index }))
                    .filter(item => item.locus.trim() !== '');

                if (quizQuestions.length === 0) {
                    showNotification("This palace has no defined locations. Please edit it first.");
                    return;
                }

            } else {
                const rangeStart = parseInt(document.getElementById('range-start').value);
                const rangeEnd = parseInt(document.getElementById('range-end').value);
                if (rangeStart > rangeEnd) {
                    showNotification("Start range cannot be greater than end range.");
                    return;
                }
                quizSettings.rangeStart = rangeStart;
                quizSettings.rangeEnd = rangeEnd;
                
                quizQuestions = pegList.filter(p => p.number >= rangeStart && p.number <= rangeEnd && p.word.trim() !== '');

                if (quizQuestions.length < 4 && quizMode === 'multiple-choice') {
                     showNotification("Need at least 4 defined pegs in this range for multiple choice.");
                     return;
                }
                if (quizQuestions.length === 0) {
                    showNotification("No peg words defined in this range.");
                    return;
                }
            }

            quizQuestions.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            userAnswers = [];
            
            showScreen('quiz-screen');
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
                return;
            }
            
            const typingArea = document.getElementById('typing-answer-area');
            const mcArea = document.getElementById('mc-answer-area');
            mcArea.style.display = 'none';
            typingArea.style.display = 'none';

            if (quizSettings.quizMode === 'multiple-choice') {
                mcArea.style.display = 'grid';
                displayMultipleChoiceQuestion();
            } else {
                typingArea.style.display = 'block';
                displayTextQuestion();
            }
        }

        function displayTextQuestion() {
            const questionItem = quizQuestions[currentQuestionIndex];
            const progressIndicator = document.getElementById('progress-indicator');
            const questionPrompt = document.getElementById('question-prompt');
            const questionDisplay = document.getElementById('question-display');
            const answerInput = document.getElementById('answer-input');
            const quizImage = document.getElementById('quiz-image');

            progressIndicator.textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
            
            let peg;
            if (quizSettings.quizMode === 'palace-walk') {
                questionPrompt.textContent = `Locus #${questionItem.index}: What's here?`;
                questionDisplay.textContent = questionItem.locus;
                answerInput.type = 'text';
                peg = pegList.find(p => p.number === questionItem.index);
            } else if (quizSettings.quizMode === 'num-to-word') {
                questionPrompt.textContent = 'What is the peg for...';
                questionDisplay.textContent = questionItem.number;
                answerInput.type = 'text';
                peg = questionItem;
            } else { // word-to-num
                questionPrompt.textContent = 'What is the number for...';
                questionDisplay.textContent = questionItem.word;
                answerInput.type = 'number';
                peg = questionItem;
            }

            if (peg && peg.imageUrl) {
                quizImage.src = peg.imageUrl;
                quizImage.classList.remove('hidden');
            } else {
                quizImage.classList.add('hidden');
            }

            answerInput.value = '';
            answerInput.focus();
            document.getElementById('feedback-indicator').textContent = '';
        }

        function displayMultipleChoiceQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('progress-indicator').textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
            document.getElementById('question-prompt').textContent = 'What is the peg for...';
            document.getElementById('question-display').textContent = question.number;
            
            const quizImage = document.getElementById('quiz-image');
            if (question.imageUrl) {
                quizImage.src = question.imageUrl;
                quizImage.classList.remove('hidden');
            } else {
                quizImage.classList.add('hidden');
            }

            const correctAnswer = question.word;
            
            const distractors = pegList
                .filter(p => p.word !== correctAnswer) 
                .sort(() => 0.5 - Math.random())
                .slice(0, 3)
                .map(p => p.word);

            const options = [correctAnswer, ...distractors].sort(() => 0.5 - Math.random());
            
            const container = document.getElementById('mc-answer-area');
            container.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-2 rounded-lg transition-transform transform hover:scale-105';
                button.textContent = option;
                button.onclick = () => checkMultipleChoiceAnswer(option, button);
                container.appendChild(button);
            });
        }

        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.toLowerCase().replace(/\s+/g, '');
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('answer-input').value;
            const currentQuestionItem = quizQuestions[currentQuestionIndex];
            
            let isCorrect = false;
            let correctAnswer;

            if (quizSettings.quizMode === 'palace-walk') {
                correctAnswer = pegList.find(p => p.number === currentQuestionItem.index).word;
                isCorrect = normalizeString(userAnswer) === normalizeString(correctAnswer);
            } else if (quizSettings.quizMode === 'num-to-word') {
                correctAnswer = currentQuestionItem.word;
                isCorrect = normalizeString(userAnswer) === normalizeString(correctAnswer);
            } else { // word-to-num
                correctAnswer = String(currentQuestionItem.number);
                isCorrect = userAnswer.trim() === correctAnswer;
            }

            userAnswers.push({ question: currentQuestionItem, answer: userAnswer, isCorrect, correctAnswer });
            document.getElementById('feedback-indicator').textContent = isCorrect ? '✅' : '❌';
            
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 700);
        }

        function checkMultipleChoiceAnswer(selectedWord, buttonElement) {
            const currentQuestion = quizQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.word;
            const isCorrect = normalizeString(selectedWord) === normalizeString(correctAnswer);

            userAnswers.push({ question: currentQuestion, answer: selectedWord, isCorrect, correctAnswer });

            document.querySelectorAll('#mc-answer-area button').forEach(btn => {
                btn.disabled = true;
                if (normalizeString(btn.textContent) === normalizeString(correctAnswer)) {
                    btn.classList.add('feedback-correct');
                }
            });

            if (!isCorrect) {
                buttonElement.classList.add('feedback-incorrect');
            }

            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 1200);
        }

        function showResults() {
            const correctAnswers = userAnswers.filter(a => a.isCorrect).length;
            const totalQuestions = userAnswers.length;
            const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

            document.getElementById('score-display').textContent = `${score}%`;

            const incorrectList = document.getElementById('incorrect-answers-list');
            incorrectList.innerHTML = '';
            const incorrectAnswers = userAnswers.filter(a => !a.isCorrect);

            if (incorrectAnswers.length > 0) {
                document.getElementById('review-section').style.display = 'block';
                incorrectAnswers.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-2 rounded-lg flex justify-between items-center';
                    
                    let questionText;
                    if (quizSettings.quizMode === 'palace-walk') {
                        questionText = `#${item.question.index}: ${item.question.locus}`;
                    } else if (quizSettings.quizMode === 'word-to-num'){
                        questionText = item.question.word;
                    } else {
                        questionText = item.question.number;
                    }

                    div.innerHTML = `
                        <div>
                            <span class="font-mono text-gray-400">${questionText}</span> &rarr; 
                            <span class="text-red-400 line-through">${item.answer || '""'}</span>
                        </div>
                        <span class="font-bold text-green-400">${item.correctAnswer}</span>
                    `;
                    incorrectList.appendChild(div);
                });
            } else {
                 document.getElementById('review-section').style.display = 'none';
            }

            showScreen('results-screen');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('answer-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') checkAnswer();
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            initializePegList();
            initializePalaces();
        };
    </script>
</body>
</html>
